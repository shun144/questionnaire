import{r as o,q,y as T,j as g}from"./app-MNzaSWed.js";import{u as f}from"./store-4eFm_Nke.js";import{D as H}from"./core.esm-ClfLRJV2.js";import L from"./Droppable-vbkIdPBH.js";import{u as Q,h as O,j as P,r as v,k as B,i as U,l as W,S as X,e as Y,f as _,C as G}from"./index-BV5GjtqN.js";/* empty css                           */import{g as E}from"./utils-DDUM_FvQ.js";import V from"./QuestionNode-Sg8KMj1B.js";import $ from"./ResultNode-Dl83w6-N.js";import z from"./FlowPanel-CAfyvnQ-.js";import"./react-9o_-8awh.js";import"./ChoiceSourceHandle-FwnCs9jg.js";import"./QuestionSubMenu-DVgmnkFN.js";import"./index-EmrQ07aD.js";import"./constants-zrKFsk20.js";import"./iconBase-C8iXxnql.js";import"./index-Dg3Bogek.js";import"./ResultSubMenu-CUoiHNyY.js";import"./ImageUploader-NEcEdkp-.js";import"./FlowSubmit-C3fcHUxV.js";import"./index-CNJg2eKG.js";import"./FlowInput-CMxA6fxJ.js";/* empty css                          */import"./FlowTitleInput-D0bV0uzU.js";import"./FlowUrlInput-BQnmukYh.js";import"./react-tooltip.min-X15aLG_L.js";import"./index-CYwCsC2B.js";import"./Draggable-DwhY28D6.js";import"./index-CS7R4WcE.js";const J=r=>{const[c,s]=o.useState(r),{addNodes:i,getNodes:u}=Q(),p=f(e=>e.setIsDirty),n=f(e=>e.setFirstNodeId),t=f(e=>e.addQnodeNum),d=f(e=>e.addRnodeNum),l=f(e=>e.setQnodeNum),a=f(e=>e.setRnodeNum);o.useEffect(()=>{l(r.filter(e=>e.type==="qNode").length),a(r.filter(e=>e.type==="rNode").length)},[]);const y=o.useMemo(()=>({qNode:V,rNode:$}),[]),k=o.useCallback(e=>{s(m=>O(e,m)),p(!0)},[s,p]);return{nodes:c,nodeTypes:y,onNodesChange:k,onAddQuestion:e=>{const m=E(),b=E();u().filter(x=>x.type==="qNode").length===0&&n(m),i({id:m,data:{topic:"",choices:[{id:b,content:""}]},position:e,type:"qNode",dragHandle:".dhandle"}),t(1)},onAddResult:e=>{const m=E();i({id:m,data:{result:""},position:e,type:"rNode",dragHandle:".dhandle"}),d(1)}}},K=r=>{const[c,s]=o.useState(r),i=f(t=>t.setIsDirty),u=o.useCallback((t,d)=>{s(l=>l.map(a=>a.id===d.id?{...a,animated:!a.animated,style:a.animated?{stroke:"gray",strokeWidth:2}:{stroke:"gold",strokeWidth:3}}:{...a,animated:!1,style:{}}))},[s]),p=o.useCallback((t,d)=>{t.preventDefault(),s(l=>l.filter(a=>a.id!==d.id))},[s]),n=o.useCallback(t=>{s(d=>P(t,d)),i(!0)},[s,i]);return{edges:c,setEdges:s,handleEdgeClick:u,handleEdgeContextMenu:p,onEdgesChange:n}},Z=r=>{const c=o.useRef(!0),s=o.useCallback((n,t)=>{n.source===t.target||t.source===n.target||(c.current=!0,r(l=>v(n,t,l)))},[]),i=o.useCallback(()=>{c.current=!1},[]),u=o.useCallback(n=>{c.current||r(t=>t.filter(d=>d.id!==n.id)),c.current=!0},[]),p=o.useCallback(n=>{n.source!==n.target&&r(t=>B({...n,type:"smoothstep"},t))},[r]);return{onReconnect:s,onReconnectStart:i,onReconnectEnd:u,onConnect:p}},ee=({initialNodes:r,initialEdges:c,defaultViewport:s})=>{const{url:i}=q(),u=f(h=>h.isDirty),{screenToFlowPosition:p}=Q(),{nodes:n,nodeTypes:t,onNodesChange:d,onAddQuestion:l,onAddResult:a}=J(r),{edges:y,setEdges:k,handleEdgeClick:S,handleEdgeContextMenu:D,onEdgesChange:e}=K(c),{onReconnect:m,onReconnectStart:b,onReconnectEnd:x,onConnect:A}=Z(k);o.useEffect(()=>{const h=T.on("before",C=>{const N=C.detail.visit;return N.url.pathname===i&&N.method==="post"?!0:u?confirm("変更が保存されていませんがページを離れてもよろしいですか？"):!0});return()=>h()},[u]);const I=o.useCallback(({active:h,over:C,delta:N,activatorEvent:R})=>{if(!(C==null||C.id!="droppableArea")&&R instanceof MouseEvent){const F=R.pageX+N.x,M=R.pageY+N.y,w={x:30,y:20},j=p({x:F-w.x,y:M-w.y});switch(h.id){case"draggable-question":l(j);break;case"draggable-result":a(j);break}}},[]);return g.jsx("div",{className:"grow w-full flex",children:g.jsx(H,{onDragEnd:I,children:g.jsx(L,{id:"droppableArea",children:g.jsxs(U,{nodes:n,edges:y,nodeTypes:t,onNodesChange:d,onEdgesChange:e,snapToGrid:!0,connectionLineType:W.SmoothStep,onReconnect:m,onReconnectStart:b,onReconnectEnd:(h,C)=>x(C),onConnect:A,onEdgeClick:S,onEdgeContextMenu:D,elevateEdgesOnSelect:!0,defaultViewport:s,panOnScroll:!0,elementsSelectable:!0,selectionMode:X.Partial,children:[g.jsx(Y,{color:"#222",variant:_.Lines,gap:20}),g.jsx(z,{}),g.jsx(G,{})]})})})})},Ae=o.memo(ee);export{Ae as default};
